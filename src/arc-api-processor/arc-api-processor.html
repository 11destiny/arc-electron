<!--
@license
Copyright 2018 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<dom-module id="arc-api-processor">
  <template>
    <style>:host {display: none !important;}</style>
    <template is="dom-if" if="[[aware]]">
      <raml-aware raml="{{amfModel}}" scope="[[aware]]"></raml-aware>
    </template>
  </template>
  <script>
  /**
   *
   * @polymer
   * @customElement
   * @memberof LogicElements
   */
  class ArcApiProcessor extends ApiElements.AmfHelperMixin(Polymer.Element) {
    static get is() {return 'arc-api-processor';}
    static get properties() {
      return {
        /**
         * `raml-aware` scope property to use.
         */
        aware: String,
        /**
         * API model
         */
        amfModel: Object,

        baseUri: {
          type: String,
          computed: '_computeBaseUri(amfModel)',
          observer: '_baseUriChanged'
        },

        apiVersion: {
          type: String,
          notify: true,
          computed: '_getApiVersion(amfModel)'
        },

        apiInfo: {
          type: Object,
          readOnly: true,
          notify: true
        },

        versions: {
          type: Array,
          notify: true,
          computed: '_computeVersionsList(apiInfo.*)'
        },

        multiVersion: {
          type: Boolean,
          notify: true,
          computed: '_computeIsMultiVersion(versions)'
        },

        saved: {
          type: Boolean,
          notify: true,
          readOnly: true
        },

        canSave: {
          type: Boolean,
          notify: true,
          computed: '_computeCanSave(baseUri, apiVersion)'
        },

        versionSaved: {
          type: Boolean,
          notify: true,
          computed: '_computeIsVersionSaved(versions, apiVersion)'
        }
      };
    }

    constructor() {
      super();
      this._indexChangeHandler = this._indexChangeHandler.bind(this);
    }

    connectedCallback() {
      super.connectedCallback();
      window.addEventListener('api-index-changed', this._indexChangeHandler);
      // window.addEventListener('api-version-deleted', this._indexChangeHandler);
    }

    disconnectedCallback() {
      super.disconnectedCallback();
      window.removeEventListener('api-index-changed', this._indexChangeHandler);
    }

    /**
     * Computes model's base Uri
     * @param {Object|Array} model AMF data model
     * @return {String}
     */
    _computeBaseUri(model) {
      if (!model) {
        return;
      }
      const server = this._computeServer(model);
      const protocols = this._computeProtocols(model);
      return this._getAmfBaseUri(server, protocols);
    }

    _getApiVersion(amfModel) {
      let version = this._computeApiVersion(amfModel);
      if (!version) {
        version = '1';
      }
      return String(version);
    }

    _baseUriChanged(baseUri) {
      this._setSaved(false);
      this._setApiInfo(undefined);
      // this._setVersions(undefined);
      if (!baseUri) {
        return;
      }
      this._getApiInfo(baseUri)
      .then((apiInfo) => {
        const saved = !!apiInfo;
        if (this.saved !== saved) {
          this._setSaved(saved);
        }
        if (saved) {
          this._setApiInfo(apiInfo);
        }
      })
      .catch((cause) => {
        console.error(cause);
      });
    }

    _computeCanSave(baseUri, apiVersion) {
      if (!baseUri || !apiVersion) {
        return false;
      }
      return true;
    }

    _getApiInfo(baseUri) {
      const e = new CustomEvent('api-index-read', {
        detail: {
          baseUri
        },
        bubbles: true,
        cancelable: true,
        composed: true
      });
      this.dispatchEvent(e);
      if (!e.defaultPrevented) {
        return Promise.reject(new Error('APIs model is not in the DOM'));
      }
      return e.detail.result;
    }

    _computeIsVersionSaved(versions, apiVersion) {
      if (!versions || !versions.length || !apiVersion) {
        return;
      }
      return versions.indexOf(apiVersion) !== -1;
    }

    _computeIsMultiVersion(versions) {
      if (!versions) {
        return false;
      }
      return versions.length > 1;
    }

    save() {
      if (!this.amfModel) {
        return Promise.reject(new Error('AMF model not set'));
      }
      if (!this.canSave) {
        return Promise.reject(new Error('API version is missing.'));
      }
      const apiInfo = this.apiInfo;
      if (!apiInfo) {
        return this._saveApi();
      }
      return this._saveVersion(apiInfo);
    }

    _saveApi() {
      const baseUri = this.baseUri;
      if (!baseUri) {
        return Promise.reject(new Error('API base URI is missing.'));
      }
      const webApi = this._computeWebApi(this.amfModel);
      const title = this._getValue(webApi, this.ns.schema.schemaName);
      if (!title) {
        return Promise.reject(new Error('API title is missing.'));
      }
      const info = {
        _id: baseUri,
        title,
        order: 0
      };
      return this._saveVersion(info);
    }

    _saveVersion(apiInfo) {
      const version = this.apiVersion;
      if (!version) {
        return Promise.reject(new Error('API version is missing.'));
      }
      return this._updateInfoObject(apiInfo, version)
      .then(() => this._updateDataObject(apiInfo._id, version));
    }

    _updateInfoObject(apiInfo, version) {
      if (!(apiInfo.versions instanceof Array)) {
        apiInfo.versions = [];
      }
      if (apiInfo.versions.indexOf(version) === -1) {
        apiInfo.versions.push(version);
      }
      apiInfo.latest = version;
      if (!this.apiInfo) {
        this._setApiInfo(apiInfo);
      }
      const e = new CustomEvent('api-index-changed', {
        detail: {
          apiInfo
        },
        bubbles: true,
        cancelable: true,
        composed: true
      });
      this.dispatchEvent(e);
      if (!e.defaultPrevented) {
        return Promise.reject(new Error('APIs model is not in the DOM'));
      }
      return e.detail.result;
    }

    _updateDataObject(id, version) {
      const e = new CustomEvent('api-data-changed', {
        detail: {
          indexId: id,
          version,
          data: this.amfModel
        },
        bubbles: true,
        cancelable: true,
        composed: true
      });
      this.dispatchEvent(e);
      if (!e.defaultPrevented) {
        return Promise.reject(new Error('APIs model is not in the DOM'));
      }
      return e.detail.result;
    }

    _indexChangeHandler(e) {
      if (e.cancelable || !this.apiInfo) {
        return;
      }
      const changed = e.detail.apiInfo;
      if (this.apiInfo._id !== changed._id) {
        return;
      }
      this._setApiInfo(changed);
      if (!this.saved) {
        this._setSaved(true);
      }
    }
    /**
     * Requests to delete current API from the data store.
     * It removes all versions of the API data and then the API index.
     * @return {Promise}
     */
    delete() {
      if (!this.saved) {
        return Promise.reject(new Error('This API is not yet saved'));
      }
      const info = this.apiInfo;
      if (!info) {
        return Promise.reject(new Error('API data not restored'));
      }
      const e = new CustomEvent('api-deleted', {
        detail: {
          id: info._id
        },
        bubbles: true,
        cancelable: true,
        composed: true
      });
      this.dispatchEvent(e);
      if (!e.defaultPrevented) {
        return Promise.reject(new Error('APIs model is not in the DOM'));
      }
      return e.detail.result;
    }
    /**
     * Removes given version of the API.
     *
     * @param {String} version
     * @return {Promise}
     */
    deleteVersion(version) {
      if (!this.saved) {
        return Promise.reject(new Error('This API is not yet saved'));
      }
      const info = this.apiInfo;
      if (!info) {
        return Promise.reject(new Error('API data not restored'));
      }
      const e = new CustomEvent('api-version-deleted', {
        detail: {
          id: info._id,
          version
        },
        bubbles: true,
        cancelable: true,
        composed: true
      });
      this.dispatchEvent(e);
      if (!e.defaultPrevented) {
        return Promise.reject(new Error('APIs model is not in the DOM'));
      }
      return e.detail.result;
    }

    getApi(id, version) {
      if (!id) {
        return Promise.reject(new Error('No API id given'));
      }
      if (!version) {
        return this._getApiInfo(id)
        .then((doc) => this._requestApiVersion(id + '|' + doc.latest));
      }
      return this._requestApiVersion(id + '|' + version);
    }

    _requestApiVersion(versionId) {
      const e = new CustomEvent('api-data-read', {
        detail: {
          id: versionId
        },
        bubbles: true,
        cancelable: true,
        composed: true
      });
      this.dispatchEvent(e);
      if (!e.defaultPrevented) {
        return Promise.reject(new Error('APIs model is not in the DOM'));
      }
      return e.detail.result
      .then((doc) => doc.data);
    }

    _computeVersionsList(record) {
      const info = record && record.base;
      if (!info) {
        return;
      }
      if (!info.versions) {
        info.versions = [];
      }
      return info.versions;
    }
  }
  window.customElements.define(ArcApiProcessor.is, ArcApiProcessor);
  </script>
</dom-module>
