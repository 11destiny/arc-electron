<link rel="import" href="../components/default/import.html">
<link rel="import" href="arc-api-processor/arc-api-processor.html">

<dom-module id="arc-electron">
  <template>
    <style>
    :host {
      display: block;
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
      @apply --layout-fit;

      --app-drawer-width: 320px;
    }

    [hidden] {
      display: none !important;
    }

    .main-container {
      @apply --layout-horizontal;
      min-height: 100%;
    }

    .pages {
      display: flex;
      padding: 0 24px;
      background-color: #fff;
      @apply --shadow-elevation-4dp;
      position: relative;
      z-index: 3;
      margin-left: var(--app-drawer-width);
      width: -webkit-fill-available;
      overflow: auto;
    }

    #pages {
      @apply --layout-flex;
      @apply --layout-vertical;
      box-sizing: border-box;
      max-width: 100%;
    }

    #pages > * {
      height: 100%;
      box-sizing: border-box;
    }

    nav {
      width: var(--app-drawer-width);
      background-color: #fff;
      position: fixed;
      z-index: 2;
    }

    .env-container {
      @apply --layout-horizontal;
      @apply --layout-center;
      @apply --arc-font-body1;
    }

    environment-selector {
      margin-left: 8px;
      max-width: 120px;
    }

    .var-panel {
      max-width: calc(100vw - var(--app-drawer-width, 0) - 32px);
      max-height: calc(100vh - 64px - 32px);
      background-color: #fff;
    }

    arc-info-messages {
      min-width: 320px;
      position: relative;
      z-index: 1;
      background-color: white;
      padding: 0 12px;
      box-sizing: border-box;
    }

    api-navigation {
      height: var(--arc-menu-height, 100vh);
      background-color: var(--arc-menu-background-color, inherit);
      --paper-tab-content-unselected_-_color: var(--arc-menu-tabs-color-unselected);
    }

    .nav-action-button {
      background-color: var(--arc-toolbar-action-button-background-color, #fff);
    }

    paper-icon-button[active] {
      color: var(--accent-color);
    }

    .nav-notification-button {
      @apply --navigation-notification-button;
    }

    .nav-notification-button:hover {
      @apply --navigation-notification-button-hover;
    }

    .nav-notification-button[active] {
      @apply --navigation-notification-button-active;
    }

    .toolbar-button {
      background-color: #fff;
    }
    </style>
    <!-- Database support -->
    <auth-data-model></auth-data-model>
    <project-model></project-model>
    <rest-api-model></rest-api-model>
    <host-rules-model></host-rules-model>
    <url-history-model></url-history-model>
    <request-model id="requestModel"></request-model>
    <authorization-data-saver></authorization-data-saver>
    <websocket-url-history-model></websocket-url-history-model>
    <variables-model></variables-model>
    <url-indexer></url-indexer>
    <!-- Data import / export -->
    <arc-data-export app-version="[[appVersion]]" electron-cookies></arc-data-export>
    <arc-data-import></arc-data-import>
    <!-- Request logic -->
    <oauth1-authorization></oauth1-authorization>
    <arc-request-logic></arc-request-logic>
    <request-hooks-logic></request-hooks-logic>
    <template is="dom-if" if="[[historyEnabled]]" restamp="true">
      <response-history-saver></response-history-saver>
    </template>
    <electron-http-transport follow-redirects$=[[config.followRedirects]] request-timeout$="[[config.requestDefaultTimeout]]" native-transport$="[[config.nativeTransport]]" validate-certificates$="[[config.validateCertificates]]" sent-message-limit$="[[config.sentMessageLimit]]"></electron-http-transport>
    <variables-manager system-variables="[[sysVars]]" sys-vars-disabled="[[!config.systemVariables]]"></variables-manager>
    <variables-evaluator no-before-request></variables-evaluator>
    <!-- Info center -->
    <arc-messages-service platform="electron" on-unread-changed="_unreadMessagesChanged" messages="{{appMessages}}" id="msgService"></arc-messages-service>
    <!-- Helper components -->
    <web-url-input id="webUrlInput" purpose="web-session" on-open-web-url="_openWebUrlHandler"></web-url-input>
    <arc-api-processor aware="apic"
      saved="{{apiIsSaved}}"
      versions="{{apiVersions}}"
      api-version="{{apiVersion}}"
      can-save="{{canSaveApi}}"
      version-saved="{{apiVersionSaved}}"
      multi-version="{{apiMultiVersionVersion}}"></arc-api-processor>
    <raml-aware id="aware" scope="apic"></raml-aware>
    <!-- Application views -->
    <app-header-layout has-scrolling-region id="scrollingRegion">
      <app-header slot="header" fixed shadow scroll-target="scrollingRegion">
        <app-toolbar>
          <template is="dom-if" if="[[renderBackButton]]">
            <paper-icon-button icon="arc:arrow-back" on-click="_backHandler" title="Go back to main screen"></paper-icon-button>
          </template>
          <template is="dom-if" if="[[!renderBackButton]]">
            <paper-icon-button icon="arc:menu" on-click="toggleDrawer" title="Toggle application menu" hidden$="[[appMenuDisabled]]"></paper-icon-button>
          </template>
          <div main-title>[[_computeAppTitle(isApiConsole)]]</div>
          <template is="dom-if" if="[[newMessages]]">
            <paper-icon-button class="nav-notification-button" icon="arc:info-outline" on-click="openInfoCenter" toggles active="[[messageCenterOpened]]" title="See what's new in the app"></paper-icon-button>
          </template>
          <template is="dom-if" if="[[hasAppUpdate]]">
            <paper-icon-button icon="arc:file-download" class="nav-notification-button" on-click="updateInstall" title="Restart and install update"></paper-icon-button>
          </template>
          <!-- API console related toolbar options -->
          <template is="dom-if" if="[[isApiConsole]]">
            <template is="dom-if" if="[[!apiIsSaved]]">
              <template is="dom-if" if="[[canSaveApi]]">
                <paper-button class="toolbar-button" raised on-click="_saveApi">Save API</paper-button>
              </template>
            </template>
            <template is="dom-if" if="[[apiIsSaved]]">
              <template is="dom-if" if="[[apiMultiVersionVersion]]">
                <paper-dropdown-menu label="API version">
                  <paper-listbox id="apiVersionSelector" slot="dropdown-content" selected="[[apiVersion]]" attr-for-selected="data-version" on-selected-changed="_apiVersionMenuChanged">
                    <template is="dom-repeat" items="[[apiVersions]]">
                      <paper-item data-version$="[[item]]">[[item]]</paper-item>
                    </template>
                  </paper-listbox>
                </paper-dropdown-menu>
              </template>

              <template is="dom-if" if="[[!apiVersionSaved]]">
                <template is="dom-if" if="[[canSaveApi]]">
                  <paper-button class="toolbar-button" raised on-click="_saveApi">Save API version</paper-button>
                </template>
              </template>

              <paper-menu-button vertical-align="top" horizontal-align="auto">
                <paper-icon-button icon="arc:more-vert" slot="dropdown-trigger"></paper-icon-button>
                <paper-listbox slot="dropdown-content" on-selected-changed="_apiActionMenuChanged">
                  <paper-item data-action="delete">Delete API</paper-item>
                  <template is="dom-if" if="[[apiMultiVersionVersion]]">
                    <paper-item data-action="delete-version">Delete version</paper-item>
                  </template>
                  <!-- <paper-item data-action="save-oas">Save as OAS</paper-item>
                  <paper-item data-action="save-raml">Save as RAML</paper-item> -->
                  <!-- <paper-item data-action="upload-exchange">Upload to Exchange</paper-item> -->
                </paper-listbox>
              </paper-menu-button>
            </template>
          </template>
          <!-- Environment toolbar controls -->
          <template is="dom-if" if="[[!isApiConsole]]">
            <div class="env-container">
              <span class="env-label">Environment:</span>
              <environment-selector no-label-float></environment-selector>
              <paper-icon-button
                class="var-info-button"
                id="varToggleButton"
                icon="arc:info-outline"
                title="Open variables list"
                active="{{_variablesOverlayOpened}}"
                toggles></paper-icon-button>
              <variables-preview-overlay
                class="var-panel"
                position-target="[[_variablesButton]]"
                dynamic-align
                horizontal-align="auto"
                vertical-align="auto"
                vertical-offset="44"
                on-open-variables-editor="_variablesOpenRequest"
                on-iron-overlay-closed="_variablesPreviewClosed"
                opened="[[_variablesOverlayOpened]]"></variables-preview-overlay>
            </div>
          </template>
        </app-toolbar>
      </app-header>
      <section role="main" class="main-container">
        <nav>
          <template is="dom-if" if="[[isApiConsole]]">
            <api-navigation aware="apic" summary endpoints-opened></api-navigation>
          </template>
          <template is="dom-if" if="[[!isApiConsole]]">
            <arc-menu
              rest-api
              hidden$="[[_computeMenuButtonHidden(appMenuDisabled, narrowNavigation)]]"
              allow-popup="[[popupMenuExperimentEnabled]]"
              list-type="[[config.viewListType]]"
              history-enabled="[[historyEnabled]]"
              hide-history="[[menuConfig.hideHistory]]"
              hide-saved="[[menuConfig.hideSaved]]"
              hide-projects="[[menuConfig.hideProjects]]"
              hide-apis="[[menuConfig.hideApis]]"
              on-popup-menu="_popupMenuHandler"></arc-menu>
          </template>
        </nav>
        <div class="pages">
          <iron-pages id="pages" class="mainPages" attr-for-selected="data-route" selected-attribute="opened" selected="[[page]]">
            <arc-request-workspace data-route="request" id="workspace"></arc-request-workspace>
            <websocket-panel data-route="socket"></websocket-panel>
            <history-panel data-route="history"></history-panel>
            <saved-requests-panel data-route="saved"></saved-requests-panel>
            <import-panel
              data-route="data-import"
              api-key="1076318174169-u4a5d3j2v0tbie1jnjgsluqk1ti7ged3.apps.googleusercontent.com"
              access-token="[[driveAccessToken]]"></import-panel>
            <export-panel data-route="data-export"></export-panel>
            <arc-settings-panel data-route="settings">
              <arc-electron-experiment-settings popup-menu-experiment-enabled="{{popupMenuExperimentEnabled}}" data-title="Experiments"></arc-electron-experiment-settings>
            </arc-settings-panel>
            <about-arc-electron data-route="about" app-version="[[appVersion]]"></about-arc-electron>
            <project-details data-route="project" id="projectDetails"></project-details>
            <google-drive-browser
              mime-type="application/restclient+data"
              data-route="drive"
              api-key="1076318174169-u4a5d3j2v0tbie1jnjgsluqk1ti7ged3.apps.googleusercontent.com"
              access-token="[[driveAccessToken]]"
              on-drive-file-picker-data="_openDriveRequest"></google-drive-browser>
            <cookie-manager data-route="cookie-manager"></cookie-manager>

            <api-documentation
              data-route="api-console"
              data-page="docs"
              aware="apic"
              id="apic"
              handle-navigation-events
              inline-methods
              narrow="[[narrow]]"
              redirect-uri="https://auth.advancedrestclient.com/oauth-popup.html"
              narrow="[[narrow]]"
              scroll-target="[[_scrollTarget]]"></api-documentation>

            <rest-apis-list-panel data-route="rest-projects" render-explore></rest-apis-list-panel>
            <exchange-search-panel
              data-route="exchange-search"
              scroll-target="[[_scrollTarget]]"
              anypoint-auth
              columns$="[[_computeExchangeColumns(exchangeMedia1, exchangeMedia2, exchangeMedia3, exchangeMedia4)]]"
              exchange-redirect-uri="https://auth.advancedrestclient.com/oauth-popup.html"
              exchange-client-id="59KaqF90hLgZMJec"
              force-oauth-events></exchange-search-panel>
            <host-rules-editor data-route="hosts-rules"></host-rules-editor>
            <themes-panel data-route="themes-panel"></themes-panel>
          </iron-pages>
        </div>
        <template is="dom-if" if="[[messageCenterOpened]]">
          <arc-info-messages messages="[[appMessages]]" on-close="closeInfoCenter"></arc-info-messages>
        </template>
      </section>
    </app-header-layout>
    <!-- Media queries to control views -->
    <iron-media-query query="(min-width: 1101px)" query-matches="{{exchangeMedia4}}"></iron-media-query>
    <iron-media-query query="(max-width: 1100px)" query-matches="{{exchangeMedia3}}"></iron-media-query>
    <iron-media-query query="(max-width: 900px)" query-matches="{{exchangeMedia2}}"></iron-media-query>
    <iron-media-query query="(max-width: 700px)" query-matches="{{exchangeMedia1}}"></iron-media-query>
    <iron-media-query query="(max-width: 700px)" query-matches="{{narrow}}"></iron-media-query>
    <!-- Components loded lazily -->
    <variables-drawer-editor id="environmentsDrawer" with-backdrop></variables-drawer-editor>
    <!-- Google Analytics -->
    <template is="dom-if" if="[[telemetry]]" restamp="true">
      <app-analytics tracking-id="UA-18021184-6" app-name="ARC-electon" app-id="[[appId]]" app-version="[[appVersion]]" data-source="electron-app">
        <template is="dom-repeat" items="[[gaCustomMetrics]]">
          <app-analytics-custom type="metric" index="[[item.index]]" value="[[item.value]]"></app-analytics-custom>
        </template>
        <template is="dom-repeat" items="[[gaCustomDimensions]]">
          <app-analytics-custom type="dimension" index="[[item.index]]" value="[[item.value]]"></app-analytics-custom>
        </template>
      </app-analytics>
      <app-analytics tracking-id="UA-18021184-14" app-name="ARC-electon" app-id="[[appId]]" app-version="[[appVersion]]" data-source="electron-app">
        <template is="dom-repeat" items="[[gaCustomMetrics]]">
          <app-analytics-custom type="metric" index="[[item.index]]" value="[[item.value]]"></app-analytics-custom>
        </template>
        <template is="dom-repeat" items="[[gaCustomDimensions]]">
          <app-analytics-custom type="dimension" index="[[item.index]]" value="[[item.value]]"></app-analytics-custom>
        </template>
      </app-analytics>
      <app-analytics tracking-id="UA-71458341-2" app-name="ARC-electon" app-id="[[appId]]" app-version="[[appVersion]]" data-source="electron-app">
        <template is="dom-repeat" items="[[gaCustomMetrics]]">
          <app-analytics-custom type="metric" index="[[item.index]]" value="[[item.value]]"></app-analytics-custom>
        </template>
        <template is="dom-repeat" items="[[gaCustomDimensions]]">
          <app-analytics-custom type="dimension" index="[[item.index]]" value="[[item.value]]"></app-analytics-custom>
        </template>
      </app-analytics>
    </template>
    <arc-license-dialog></arc-license-dialog>
    <paper-toast id="errorToast" duration="5000"></paper-toast>
  </template>
  <script>
  /**
   * Main component for ARC electron app.
   *
   * @appliesMixin ArcComponents.ArcAppMixin
   */
  class ArcElectron extends ArcComponents.ArcAppMixin(Polymer.Element) {
    static get is() {return 'arc-electron';}
    static get properties() {
      return {
        /**
         * A reference to the variables open button.
         * @type {String}
         */
        _variablesButton: Object,
        /**
         * A logger
         */
        log: {
          type: Object,
          value: function() {
            /* global log */
            return log;
          }
        },
        /**
         * When true it is rendering API console view.
         */
        isApiConsole: {type: Boolean, value: false, readOnly: true},
        /**
         * System variables
         */
        sysVars: {
          type: Object,
          value: function() {
            return process.env;
          }
        },
        _variablesOverlayOpened: {
          type: Boolean,
          observer: '_varsOverlayChanged'
        },

        appMenuDisabled: {
          type: Boolean,
          reflectToAttribute: true,
          computed: '_computeAppMenuDisabled(menuConfig.*)',
          observer: '_menuDisabledChanged'
        },
        /**
         * Computed value. When `true` it renders `back` button instead of menu.
         * @type {Boolean}
         */
        renderBackButton: {
          type: Boolean,
          value: false,
          computed: '_computeRenderBackButton(page)'
        },
        /**
         * When set menu drawer is hidden.
         */
        narrowNavigation: {
          type: Boolean,
          observer: '_menuDisabledChanged'
        },
        /**
         * Automatically set via media queries.
         * When set it renders narrow wiew.
         * This also affects API console.
         */
        narrow: {
          type: Boolean,
          observer: '_narrowChanged'
        },
        /**
         * Currently opened application screen
         * @type {String}
         */
        page: {type: String, value: 'request', observer: '_pageChanged'}
      };
    }

    constructor() {
      super();
      this._openExternalHandler = this._openExternalHandler.bind(this);
      this._copyContentHandler = this._copyContentHandler.bind(this);
      this._apiDataHandler = this._apiDataHandler.bind(this);
      this._processStartHandler = this._processStartHandler.bind(this);
      this._processStopHandler = this._processStopHandler.bind(this);
      this._processErrorHandler = this._processErrorHandler.bind(this);
    }

    static get observers() {
      return [
        '_routeDataChanged(page, routeParams.*)'
      ];
    }

    connectedCallback() {
      super.connectedCallback();
      window.addEventListener('open-external-url', this._openExternalHandler);
      window.addEventListener('content-copy', this._copyContentHandler);
      window.addEventListener('api-data-ready', this._apiDataHandler);
      window.addEventListener('process-loading-start', this._processStartHandler);
      window.addEventListener('process-loading-stop', this._processStopHandler);
      window.addEventListener('process-error', this._processErrorHandler);
      Polymer.RenderStatus.afterNextRender(this, () => {
        this._variablesButton = this.shadowRoot.querySelector('#varToggleButton');
        this._scrollTarget = this.$.scrollingRegion.$.contentContainer;
      });
    }

    _routeDataChanged(page, changeRecord) {
      const params = changeRecord.base;
      switch (page) {
        case 'request':
          this._setupRequest(params);
          break;
        case 'project':
          this._setupProject(params);
          break;
        case 'api-console':
          this._setupApiConsole(params);
          break;
      }
    }

    /**
     * Loads a page component when page changes.
     * @param {String} page Current page
     */
    _pageChanged(page) {
      let id;
      let path;
      switch (page) {
        case 'request':
          id = 'arc-request-workspace';
          path = 'arc-request-workspace/arc-request-workspace';
          break;
        case 'project':
          id = 'project-details';
          path = 'project-details/project-details';
          break;
        case 'hosts-rules':
          id = 'host-rules-editor';
          path = 'host-rules-editor/host-rules-editor';
          break;
        case 'cookie-manager':
          id = 'cookie-manager';
          path = 'cookie-manager/cookie-manager';
          break;
        case 'settings':
          id = 'arc-settings-panel';
          path = 'arc-settings-panel/arc-settings-panel';
          break;
        case 'about':
          id = 'about-arc-electron';
          path = 'about-arc-electron/about-arc-electron';
          break;
        case 'socket':
          id = 'websocket-panel';
          path = 'websocket-panel/websocket-panel';
          break;
        case 'exchange-search':
          id = 'exchange-search-panel';
          path = 'exchange-search-panel/exchange-search-panel';
          break;
        case 'api-console':
          id = 'api-console';
          path = 'api-console/api-console';
          break;
        case 'drive':
          id = 'google-drive-browser';
          path = 'google-drive-browser/google-drive-browser';
          break;
        case 'data-import':
          id = 'import-panel';
          path = 'import-panel/import-panel';
          break;
        case 'data-export':
          id = 'export-panel';
          path = 'export-panel/export-panel';
          break;
        case 'rest-projects':
          id = 'rest-apis-list-panel';
          path = 'rest-apis-list-panel/rest-apis-list-panel';
          break;
        default:
          console.error(`The base route ${page} is not recognized`);
          return;
      }
      const cls = window.customElements.get(id);
      if (cls) {
        return;
      }
      this._loadComponent(path)
      .catch((cmp) => this._reportComponentLoadingError(cmp));
    }

    initApplication() {
      Polymer.RenderStatus.afterNextRender(this, () => this.initSettings({}));
      Polymer.RenderStatus.afterNextRender(this, () => this.updateStyles({}));
      Polymer.RenderStatus.afterNextRender(this, () => this._requestAuthToken(false));
    }

    _setupRequest(params) {
      if (!params) {
        return;
      }
      const {id, type} = params;
      if (!type || !this.$.workspace.addEmptyRequest) {
        this.log.info('arc-electron::_setupRequest::Missing use case implementation?');
        return;
      }
      if (!type || type === 'new') {
        if (this.$.workspace.addEmptyRequest) {
          this.$.workspace.addEmptyRequest();
        } else {
          this.log.info('arc-electron::_setupRequest::Missing use case implementation?');
        }
        return;
      }
      if (params.type === 'latest' || !params.id) {
        return;
      }
      this.$.requestModel.read(type, id)
      .then((request) => {
        const index = this.$.workspace.findRequestIndex(request._id);
        if (index === -1) {
          this.$.workspace.appendRequest(request);
        } else {
          this.$.workspace.updateRequestObject(request, index);
          this.$.workspace.selected = index;
        }
      })
      .catch((cause) => {
        this.log.warn('Restoring request:', cause);
      });
    }

    _setupProject(params) {
      if (!params) {
        return;
      }
      this.$.projectDetails.projectId = params.id;
    }

    _setupApiConsole(params) {
      if (!params) {
        return;
      }
      const {id, version} = params;
      if (!id) {
        return;
      }
      this.shadowRoot.querySelector('arc-api-processor')
      .getApi(id, version)
      .then((api) => this._setApiData(api))
      .catch((cause) => {
        this.notifyError(cause.message);
      });
    }
    /**
     * The overlay is not included by default in the view so it loads the
     * component first and then renders it. Subsequent opens do not require
     * inluding the comonent.
     *
     * @param {Boolean} val
     */
    _varsOverlayChanged(val) {
      if (val && !customElements.get('variables-preview-overlay')) {
        this._loadComponent('variables-preview-overlay/variables-preview-overlay')
        .catch((cmp) => this._reportComponentLoadingError(cmp));
      }
    }

    _variablesOpenRequest(e) {
      e.stopPropagation();
      this._variablesOverlayOpened = false;
      this._loadComponent('variables-drawer-editor/variables-drawer-editor')
      .then(() => {
        this.$.environmentsDrawer.opened = true;
      })
      .catch((cmp) => this._reportComponentLoadingError(cmp));
    }

    _variablesPreviewClosed() {
      if (this._variablesOverlayOpened) {
        this._variablesOverlayOpened = false;
      }
    }
    /**
     * Loads `web-url-input` component and runs it to ask the user for the URL
     * to open in session window. Cookies recorded in the window are becomming
     * requests session cookies.
     */
    openWebUrl() {
      this._loadComponent('web-url-input/web-url-input')
      .then(() => {
        this.$.webUrlInput.opened = true;
      })
      .catch((cmp) => this._reportComponentLoadingError(cmp));
    }

    _openWebUrlHandler(e) {
      ipc.send('open-web-url', e.detail.url, e.detail.purpose);
    }

    _requestAuthToken(interactive, scope) {
      if (this.__requestingToken) {
        return;
      }
      this.__requestingToken = true;
      /* global ipc */
      ipc.send('oauth-2-get-token', {
        interactive: interactive,
        scopes: scope
      });
      const context = this;
      let rejected;
      function resolved(sender, token) {
        const tokenValue = token ? token.accessToken : undefined;
        context.__requestingToken = false;
        ipc.removeListener('oauth-2-token-ready', resolved);
        ipc.removeListener('oauth-2-token-error', rejected);
        context.dispatchEvent(new CustomEvent('google-signin-success', {
          composed: true,
          cancelable: true,
          bubbles: true,
          detail: {
            scope: scope,
            token: tokenValue
          }
        }));
        context.driveAccessToken = tokenValue;
      }
      rejected = function() {
        context.__requestingToken = false;
        ipc.removeListener('oauth-2-token-ready', resolved);
        ipc.removeListener('oauth-2-token-error', rejected);
        context.dispatchEvent(new CustomEvent('google-signout', {
          composed: true,
          cancelable: true,
          bubbles: true,
          detail: {
            scope: scope
          }
        }));
      };
      ipc.on('oauth-2-token-ready', resolved);
      ipc.on('oauth-2-token-error', rejected);
    }
    /**
     * Sets `newMessages` propert depending if messaging service detected
     * new messages.
     *
     * @param {CustomEvent} e
     */
    _unreadMessagesChanged(e) {
      const state = !!(e.detail.value && e.detail.value.length > 0);
      this.set('newMessages', state);
    }
    /**
     * Opens the info center drawwer.
     */
    openInfoCenter() {
      this.messageCenterOpened = !this.messageCenterOpened;
      if (this.messageCenterOpened) {
        this.$.msgService.readMessages();
        window.setTimeout(() => {
          this.$.msgService.unread.forEach((item, i) => {
            this.$.msgService.set(['unread', i, 'read'], 1);
          });
        }, 4000);
      }
    }
    /**
     * Closes the info center drawwer.
     */
    closeInfoCenter() {
      this.messageCenterOpened = false;
    }
    /**
     * Handles `open-external-url` event from ARC components.
     * @param {CustomEvent} e
     */
    _openExternalHandler(e) {
      e.preventDefault();
      /* global ipcRenderer */
      ipcRenderer.send('open-external-url', e.detail.url);
    }
    /**
     * Handles new window open request.
     */
    onNewWindow() {
      ipcRenderer.send('new-window');
    }
    /**
     * Handles `clipboard-copy` event from ARC components.
     * The `clipboard` api is loaded in the preload script.
     *
     * @param {CustomEvent} e
     */
    _copyContentHandler(e) {
      /* global clipboard */
      clipboard.writeText(e.detail.value);
      e.preventDefault();
    }
    /**
     * Installs pading update.
     */
    updateInstall() {
      ipcRenderer.send('install-update');
    }

    _apiDataHandler(e) {
      const api = e.detail.api;
      this._setApiData(api)
      .then(() => {
        this._dispatchNavigate({
          base: 'api-console'
        });
      });
    }

    _setApiData(api) {
      return this._loadComponent('api-console/api-console')
      .then(() => {
        this.$.aware.raml = api;
        this.$.apic.selected = 'summary';
        this.$.apic.selectedType = 'summary';
        this._setIsApiConsole(true);
      })
      .catch((cmp) => this._reportComponentLoadingError(cmp));
    }

    /**
     * Handles opening a file from Google Drive.
     * Dispatches `import-process-file` so the import module processes the data
     *
     * @param {CustomEvent} e
     */
    _openDriveRequest(e) {
      const file = new Blob([e.detail.content], {type: 'application/json'});
      this.dispatchEvent(new CustomEvent('import-process-file', {
        bubbles: true,
        composed: true,
        cancelable: true,
        detail: {
          file,
          diveId: e.detail.diveId
        }
      }));
    }

    notifyError(message) {
      this.$.errorToast.text = message;
      this.$.errorToast.opened = true;
    }

    _computeAppTitle(isApic) {
      return isApic ? 'API console' : 'Advanced REST Client';
    }
    /**
     * Closes API console view
     */
    closeApiConsole() {
      this._setIsApiConsole(false);
      this.page = 'exchange-search';
    }
    /**
     * Handler for `process-loading-start` custom event.
     * Renders toast with message.
     * @param {CustomEvent} e
     */
    _processStartHandler(e) {
      const {id, message, indeterminate} = e.detail;
      if (!id) {
        console.warn('Invalid use of `process-loading-start` event');
        return;
      }
      const toast = document.createElement('paper-toast');
      toast.dataset.processId = id;
      if (indeterminate) {
        toast.duration = 0;
      }
      const container = document.createElement('dis');
      container.style.display = 'flex';
      container.style.flexDirection = 'row';
      container.style.alignItems = 'center';
      const label = document.createElement('span');
      label.innerText = message;
      label.style.flex = 1;
      label.style.flexBasis = '0.000000001px';
      container.appendChild(label);
      const spinner = document.createElement('paper-spinner');
      spinner.active = true;
      container.appendChild(spinner);
      toast.appendChild(container);
      document.body.appendChild(toast);
      toast.opened = true;
    }
    /**
     * Handler for `process-loading-stop` custom event.
     * Removes previously set toast
     * @param {CustomEvent} e
     */
    _processStopHandler(e) {
      const {id} = e.detail;
      if (!id) {
        console.warn('Invalid use of `process-loading-stop` event');
        return;
      }
      const node = document.body.querySelector(`[data-process-id="${id}"]`);
      if (!node) {
        return;
      }
      node.opened = false;
      node.addEventListener('iron-overlay-closed', function f() {
        node.removeEventListener('iron-overlay-closed', f);
        node.parentNode.removeChild(node);
      });
    }
    /**
     * Handler for `process-error` custom event.
     * Removes previously set progress toasts and adds new with error.
     * @param {CustomEvent} e
     */
    _processErrorHandler(e) {
      const nodes = document.body.querySelector(`[data-process-id]`);
      for (let i = nodes.length - 1; i >= 0; i--) {
        nodes[i].parentNode.removeChild(nodes[i]);
      }
      this.notifyError(e.detail.message);
    }
    /**
     * Opens license dialog.
     */
    openLicense() {
      this._loadComponent('arc-license-dialog/arc-license-dialog')
      .then(() => {
        const node = this.shadowRoot.querySelector('arc-license-dialog');
        node.opened = true;
      })
      .catch((cmp) => this._reportComponentLoadingError(cmp));
    }
    /**
     * Handler for `popup-menu`. Sends command to the IO process.
     * IO process informs windows to hide the menu.
     * @param {CustomEvent} e
     */
    _popupMenuHandler(e) {
      const {type} = e.detail;
      let sizing;
      const menu = this.shadowRoot.querySelector('arc-menu');
      if (menu) {
        const rect = menu.getBoundingClientRect();
        sizing = {
          height: rect.height,
          width: rect.width
        };
      }
      ipcRenderer.send('popup-app-menu', type, sizing);
    }
    /**
     * Computes value for `appMenuDisabled` property.
     * @param {Object} record Polymer's change record for `menuConfig`
     * @param {Boolean} narrowNavigation
     * @return {Boolean}
     */
    _computeAppMenuDisabled(record, narrowNavigation) {
      if (narrowNavigation) {
        return true;
      }
      if (!record || !record.base) {
        return false;
      }
      const mc = record.base;
      if (mc.menuDisabled) {
        return true;
      }
      if (mc.hideHistory && mc.hideSaved && mc.hideProjects && mc.hideApis) {
        return true;
      }
      return false;
    }
    /**
     * Toggles main page view margin when menu is hidden.
     * @param {Boolean} value
     */
    _menuDisabledChanged(value) {
      let newWidth;
      if (value) {
        this._oldDrawerWidth = this._getDrawerVidithValue();
        newWidth = '0';
      } else {
        newWidth = this._oldDrawerWidth || '320px';
      }
      this.updateStyles({
        '--app-drawer-width': newWidth
      });
    }

    _getDrawerVidithValue() {
      const prop = '--app-drawer-width';
      if (window.ShadyCSS) {
        return window.ShadyCSS.getComputedStyleValue(this, prop);
      } else {
        return getComputedStyle(this).getPropertyValue(prop);
      }
    }
    /**
     * Computes value for `renderBackButton` property.
     * @param {String} page Current page value
     * @return {Boolean}
     */
    _computeRenderBackButton(page) {
      return !page || page !== 'request';
    }

    toggleDrawer() {
      this.narrowNavigation = !this.narrowNavigation;
    }

    _computeMenuButtonHidden(appMenuDisabled, narrowNavigation) {
      return appMenuDisabled || narrowNavigation;
    }
    /**
     * Computes number of columns to be set on Exchange lsit panel
     * based on current media query state.
     * @param {Boolean} exchangeMedia1
     * @param {Boolean} exchangeMedia2
     * @param {Boolean} exchangeMedia3
     * @param {Boolean} exchangeMedia4
     * @return {Number}
     */
    _computeExchangeColumns(exchangeMedia1, exchangeMedia2, exchangeMedia3, exchangeMedia4) {
      if (exchangeMedia4) {
        return 4;
      }
      if (exchangeMedia1 || exchangeMedia2) {
        return 2;
      }
      if (exchangeMedia3) {
        return 3;
      }
      return 4;
    }
    /**
     * Handler for `narrow` attribute change.
     * @param {Boolean} narrow
     */
    _narrowChanged(narrow) {
      this.narrowNavigation = narrow;
    }
    /**
     * Handler for the "back" icon click in main navigation.
     */
    _backHandler() {
      if (this.isApiConsole) {
        this._setIsApiConsole(false);
      }
      this.openWorkspace();
    }

    _saveApi() {
      this.shadowRoot.querySelector('arc-api-processor').save();
    }

    _apiActionMenuChanged(e) {
      const selected = e.detail.value;
      if (selected === undefined || selected === -1) {
        return;
      }
      const item = e.target.selectedItem;
      const action = item.dataset.action;
      let p;
      switch (action) {
        case 'delete':
          p = this.shadowRoot.querySelector('arc-api-processor').delete();
          break;
        case 'delete-version':
          const v = this.shadowRoot.querySelector('#apiVersionSelector').selected;
          p = this.shadowRoot.querySelector('arc-api-processor').deleteVersion(v);
          break;
        case 'save-oas':
          this.shadowRoot.querySelector('arc-api-processor').saveAs('oas');
          break;
        case 'save-raml':
          this.shadowRoot.querySelector('arc-api-processor').saveAs('raml');
          break;
        case 'upload-exchange':
          log.info('Not yet supported.');
          break;
      }
      e.target.selected = undefined;
      if (p) {
        p.catch((cause) => this.notifyError(cause.message));
      }
    }

    _apiVersionMenuChanged(e) {
      const {value} = e.detail;
      if (!value) {
        return;
      }
      const id = this.shadowRoot.querySelector('arc-api-processor').apiInfo._id;
      const params = {
        id,
        version: value
      };
      this._setupApiConsole(params);
    }
  }
  window.customElements.define(ArcElectron.is, ArcElectron);
    //   listeners: {
    //     'pick-google-drive-item': 'openDrivePicker',
    //     'open-drive-selector': 'openDrivePicker',
    //   },
    //
    //   _driveFileRouteChanged(initialized, record) {
    //     if (!initialized) {
    //       return;
    //     }
    //     var params = record && record.base;
    //     if (!params || !params.action || !params.id) {
    //       return;
    //     }
    //     // open and create actions are basically the same...
    //     this.openDriveItem(params.id);
    //   },
    //
    //   openDriveItem(id) {
    //     Polymer.RenderStatus.afterNextRender(this, function() {
    //       if (!this.driveAccessToken) {
    //         this.addEventListener('oauth-2-token-ready', function clb() {
    //           this.removeEventListener('oauth-2-token-ready', clb);
    //           this.openDriveItem(id);
    //         });
    //         return this._requestAuthToken(true);
    //       }
    //       this.fire('navigate', {
    //         base: 'drive'
    //       });
    //       var picker = Polymer.dom(this.root).querySelector('google-drive-browser');
    //       picker._isOpened = true;
    //       picker._downloadFile(id);
    //     });
    //   },
    //
    //   _computePinDrawerClass(forceNarrowLayout, narrowLayout, drawerOpened) {
    //     var clazz = 'drawer-pin';
    //     if (forceNarrowLayout && narrowLayout && drawerOpened) {
    //       clazz += ' visible';
    //     }
    //     return clazz;
    //   }
  </script>
</dom-module>
