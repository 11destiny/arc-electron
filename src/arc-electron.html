<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/font-roboto-local/roboto.html">
<link rel="import" href="../bower_components/paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/arc-icons/arc-icons.html">
<link rel="import" href="../bower_components/arc-menu/arc-menu.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/websocket-panel/websocket-panel.html">
<link rel="import" href="../bower_components/arc-settings-panel/arc-settings-panel.html">
<link rel="import" href="../bower_components/saved-requests-panel/saved-requests-panel.html">
<link rel="import" href="../bower_components/history-panel/history-panel.html">
<link rel="import" href="../bower_components/google-drive-browser/google-drive-browser.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/arc-data-import/arc-data-import.html">
<link rel="import" href="../bower_components/arc-data-export/arc-data-export.html">
<link rel="import" href="../bower_components/data-import-export-panel/data-import-export-panel.html">
<link rel="import" href="../bower_components/search-bar/search-bar.html">
<link rel="import" href="../bower_components/drop-file-importer/drop-file-importer.html">
<link rel="import" href="../bower_components/authorization-data-saver/authorization-data-saver.html">
<link rel="import" href="../bower_components/cookie-jar/cookie-jar.html">
<link rel="import" href="../bower_components/response-history-saver/response-history-saver.html">
<link rel="import" href="../bower_components/url-history-saver/url-history-saver.html">
<link rel="import" href="../bower_components/variables-manager/variables-manager.html">
<link rel="import" href="../bower_components/variables-evaluator/variables-evaluator.html">
<link rel="import" href="../bower_components/request-saver/request-saver.html">
<link rel="import" href="../bower_components/arc-definitions/arc-definitions.html">
<link rel="import" href="../bower_components/arc-license-dialog/arc-license-dialog.html">
<link rel="import" href="../bower_components/arc-models/project-model.html">
<link rel="import" href="../bower_components/arc-onboarding/arc-onboarding.html">
<link rel="import" href="../bower_components/app-analytics/app-analytics.html">
<link rel="import" href="../bower_components/app-analytics/app-analytics-custom.html">
<link rel="import" href="../bower_components/app-logger/app-logger.html">
<link rel="import" href="../bower_components/project-details/project-details.html">
<link rel="import" href="../styles/app-theme.html">
<link rel="import" href="arc-request-panel/arc-request-panel.html">
<link rel="import" href="file-export/file-export.html">
<link rel="import" href="about-arc/about-arc.html">
<link rel="import" href="electron-drive/electron-drive.html">

<dom-module id="arc-electron">
  <template>
    <style>
    :host {
      display: block;
      position: relative;
      min-height: 100vh;
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
      background-color: var(--primary-background-color);
    }

    [hidden] {
      display: none !important;
    }

    .mainPages > * {
      min-height: calc(100vh - 64px);
      height: calc(100vh - 64px);
    }

    .content,
    #pages {
      min-height: 100%;
      height: 100%;
    }

    paper-toolbar paper-icon-button {
      color: rgba(255, 255, 255, 0.87);
    }

    paper-toolbar paper-icon-button:hover {
      color: var(--hover-button-accent-color);
    }

    #drawerResizer {
      position: absolute;
      bottom: 0;
      top: 0;
      right: 0;
      width: 3px;
      background-color: transparent;
      cursor: ew-resize;
      transition: width 0.2s ease-in-out, background-color 0.2s ease-in-out;
    }

    #drawerResizer:hover {
      background-color: #BDBDBD;
      width: 6px;
    }

    .app-name {
      font-family: 'Roboto', 'Noto', sans-serif;
      -webkit-font-smoothing: antialiased;
      font-size: 16px;
      font-weight: 400;
      line-height: 24px;
    }

    .drawer-toggle-button {
      display: inline-block !important;
    }

    .drawer-pin {
      display: none;
    }
    .drawer-pin.visible {
      display: inline-block;
    }
    </style>

    <app-location route="{{route}}" use-hash-as-path></app-location>
    <app-route route="{{route}}" pattern="/:base" data="{{routeData}}"></app-route>
    <app-route route="{{route}}" pattern="/project/:id" data="{{projectRoute}}"></app-route>
    <app-route route="{{route}}" pattern="/request/:type/:id" data="{{requestRoute}}"></app-route>
    <app-route route="{{route}}" pattern="/request/drive/:action/:id" data="{{driveFileRoute}}"></app-route>

    <paper-drawer-panel responsive-width="1000px" id="paperDrawerPanel" force-narrow="{{forceNarrowLayout}}" narrow="{{narrowLayout}}" drawer-width="[[drawerWidth]]" disable-edge-swipe disable-swipe>
      <paper-scroll-header-panel drawer>
        <paper-toolbar class="main-toolbar">
          <paper-icon-button icon="arc:menu" paper-drawer-toggle class="drawer-toggle-button" on-tap="toggleDrawer" title="Toggle drawer" alt="Drawer toggle icon"></paper-icon-button>
          <div class="app-name flex">ARC</div>
          <paper-icon-button icon="arc:pin-drawer" class$="[[_computePinDrawerClass(forceNarrowLayout, narrowLayout)]]" on-tap="_pinDrawer" title="Pin drawer" alt="Pin drawer"></paper-icon-button>
        </paper-toolbar>
        <arc-menu selected-request="[[selectedRequest]]" route-base="[[routeData.base]]"></arc-menu>
        <div id="drawerResizer"></div>
      </paper-scroll-header-panel>
      <paper-scroll-header-panel main id="headerPanelMain">
        <!-- Main Toolbar -->
        <paper-toolbar id="mainToolbar" class="main-toolbar">
          <paper-icon-button class="toolbar-hide" icon="arc:menu" paper-drawer-toggle title="Toggle drawer" alt="Drawer toggle icon"></paper-icon-button>
          <div class="title">[[pageTitle]]</div>
        </paper-toolbar>
        <!-- Main Content -->
        <div class="content">
          <!-- iron-pages -->
          <iron-pages id="pages"
            class="mainPages"
            attr-for-selected="data-route"
            selected-attribute="opened"
            selected="[[routeData.base]]">
            <arc-request-panel data-route="request" route-params="{{requestRoute}}"></arc-request-panel>
            <websocket-panel attr-for-opened="opened" data-route="socket"></websocket-panel>
            <history-panel attr-for-opened="opened" data-route="history"></history-panel>
            <saved-requests-panel attr-for-opened="opened" data-route="saved"></saved-requests-panel>
            <data-import-export-panel data-route="dataimport" api-key="1076318174169-u4a5d3j2v0tbie1jnjgsluqk1ti7ged3.apps.googleusercontent.com"></data-import-export-panel>
            <arc-settings-panel data-route="settings"></arc-settings-panel>
            <about-arc data-route="about" update-state="[[updateState]]"></about-arc>
            <project-details attr-for-opened="opened" data-route="project" project-id="[[projectRoute.id]]" attr-for-opened="opened"></project-details>
            <google-drive-browser mime-type="application/restclient+data" data-route="drive" attr-for-opened="opened" api-key="1076318174169-u4a5d3j2v0tbie1jnjgsluqk1ti7ged3.apps.googleusercontent.com" access-token="[[accessToken]]" on-drive-file-picker-data="_openDriveRequest"></google-drive-browser>
          </iron-pages>
        </div>
      </paper-scroll-header-panel>
    </paper-drawer-panel>
    <drop-file-importer></drop-file-importer>
    <arc-license-dialog></arc-license-dialog>
    <arc-onboarding></arc-onboarding>
    <paper-toast id="errorToast" duration="5000"></paper-toast>
    <paper-toast id="offlineToast" class="offline-toast" text="You are now offline. Can't make new requests."></paper-toast>
    <search-bar id="content-search-bar" on-iron-overlay-opened="textSearchBarOpened"></search-bar>
    <template is="dom-if" if="[[telemetry]]" restamp="true">
      <app-analytics tracking-id="UA-18021184-6" app-name="ARC-electon" app-id="[[appId]]" app-version="[[appVersion]]" data-source="electron-app">
        <template is="dom-repeat" items="[[gaCustomMetrics]]">
          <app-analytics-custom type="metric" index="[[item.index]]" value="[[item.value]]"></app-analytics-custom>
        </template>
        <template is="dom-repeat" items="[[gaCustomDimensions]]">
          <app-analytics-custom type="dimension" index="[[item.index]]" value="[[item.value]]"></app-analytics-custom>
        </template>
      </app-analytics>
      <app-analytics tracking-id="UA-18021184-14" app-name="ARC-electon" app-id="[[appId]]" app-version="[[appVersion]]" data-source="electron-app">
        <template is="dom-repeat" items="[[gaCustomMetrics]]">
          <app-analytics-custom type="metric" index="[[item.index]]" value="[[item.value]]"></app-analytics-custom>
        </template>
        <template is="dom-repeat" items="[[gaCustomDimensions]]">
          <app-analytics-custom type="dimension" index="[[item.index]]" value="[[item.value]]"></app-analytics-custom>
        </template>
      </app-analytics>
      <app-analytics tracking-id="UA-71458341-2" app-name="ARC-electon" app-id="[[appId]]" app-version="[[appVersion]]" data-source="electron-app">
        <template is="dom-repeat" items="[[gaCustomMetrics]]">
          <app-analytics-custom type="metric" index="[[item.index]]" value="[[item.value]]"></app-analytics-custom>
        </template>
        <template is="dom-repeat" items="[[gaCustomDimensions]]">
          <app-analytics-custom type="dimension" index="[[item.index]]" value="[[item.value]]"></app-analytics-custom>
        </template>
      </app-analytics>
    </template>
    <app-logger></app-logger>
    <arc-definitions></arc-definitions>
    <variables-evaluator no-before-request></variables-evaluator>
    <variables-manager></variables-manager>
    <request-saver></request-saver>
    <cookie-jar></cookie-jar>
    <response-history-saver></response-history-saver>
    <url-history-saver></url-history-saver>
    <arc-data-export></arc-data-export>
    <arc-data-import></arc-data-import>
    <authorization-data-saver></authorization-data-saver>
    <project-model></project-model>
    <!-- Electron specific -->
    <file-export></file-export>
    <electron-drive></electron-drive>
  </template>
  <script>
    const {ArcPreferences} = require('./scripts/arc-preferences');
    const ipc = require('electron').ipcRenderer;
    const {app} = require('electron').remote;
    Polymer({
      is: 'arc-electron',

      properties: {
        pageTitle: String,
        selectedRequest: String,
        route: Object,
        routeData: Object,
        driveFileRoute: Object,
        // Application ID for analytics
        appId: {
          type: String,
          value: 'com.mulesoft.arc'
        },
        // Current application varsion
        appVersion: {
          type: String,
          value: function() {
            return app.getVersion();
          }
        },
        gaCustomMetrics: Array,
        gaCustomDimensions: Array,
        drawerWidth: {
          type: String,
          value: '360px'
        },
        forceNarrowLayout: {
          type: Boolean,
          value: false
        },
        narrowLayout: {
          type: Boolean,
          value: false
        },

        _drawerInitTrackWidth: Number,
        _drawerInitTransition: Number,
        accessToken: String,
        // Latest update event data
        updateState: Array,
        /**
         * Sets Google Analytics state. If this is not set or falsy, then Google
         * Analytics is diosabled (element is removed from the DOM).
         */
        telemetry: Boolean
      },

      created: function() {
        this.__prefs = new ArcPreferences();
        this.__prefs.observe();
      },

      attached: function() {
        Polymer.RenderStatus.afterNextRender(this, function() {
          this.listen(document.body, 'display-license', 'openLicense');
          this._observeMainEvents();
        });
      },

      detacheded: function() {
        this.unlisten(document.body, 'display-license', 'openLicense');
        this._unobserveMainEvents();
      },

      listeners: {
        navigate: '_navigateHandler',
        'drawerResizer.track': '_drawerTrack',
        tap: '_handleLinks',
        'content-copy': '_copyContentHandler',
        'google-autorize': '_googleOauthTokenRequested',
        'process-incoming-data': '_processIcomingDataHandler',
        'pick-google-drive-item': 'openDrivePicker',
        'open-drive-selector': 'openDrivePicker',
        'settings-changed': '_settingChanged',
        'open-external-url': '_openExternalHandler',
        'app-version': '_appVersionRequestHandler'
      },

      observers: [
        '_setupRequestRoute(requestRoute.*)',
        '_driveFileRouteChanged(driveFileRoute.*)'
      ],

      _routeDataChanged: function(record) {
        var params = record && record.base;
        switch (params.base) {
          case 'request':
            return this._setupRequestRoute(params);
        }
      },

      ready: function() {
        // sets a default path of not initialized with path
        if (!this.route.path) {
          this.set('route.path', '/request/latest/0');
        }
        this._requestAuthToken(false);
        this.setupAnalytics();
      },
      /**
       * Reads current settings and enables Google Analytics if it's not
       * disabled by the uers.
       */
      setupAnalytics: function() {
        var event = this.fire('settings-read', {}, {
          composed: true,
          cancelable: true
        });
        if (!event.defaultPrevented) {
          throw new Error('Settings provided not found.');
        }
        return event.detail.result.then(settings => {
          if (settings.telemetry === false) {
            this._analyticsDisabled();
          } else {
            this._analyticsEnabled();
          }
        });
      },
      /**
       * Enables Google Analytics.
       *
       * Until settings status is checked Google Analytics components is not
       * even in the DOM. Once the `telemetry` flag is set analytics elements
       * are attached to the DOM and start handling events.
       *
       * This can be disabled by calling `_analyticsDisabled` or by sending
       * `settings-changed` custom event with `telemetry` key.
       */
      _analyticsEnabled: function() {
        this.telemetry = true;
        if (this.gaCustomDimensions) {
          return;
        }
        this.gaCustomDimensions = [];
        this.push('gaCustomDimensions', {
          index: 1,
          value: process.versions.chrome
        });
        this.push('gaCustomDimensions', {
          index: 2,
          value: this.appVersion
        });
        this.push('gaCustomDimensions', {
          index: 5,
          value: 'stable'
        });
      },
      // To be called if GA is disabled to remove GA elements from the DOM.
      _analyticsDisabled: function() {
        this.telemetry = false;
        // no need to clean up custom dimensions
        // since it is removed from DOM anyway.
      },
      /**
       * Handles settings change event.
       * If changed setting is `telemetry` then it upodates GA state.
       */
      _settingChanged: function(e) {
        // Here we just care about `telemetry`
        if (e.detail.name !== 'telemetry') {
          return;
        }
        var value = e.detail.value;
        if (typeof value !== 'boolean') {
          value = value === 'false' ? false : true;
        }
        if (value) {
          this._analyticsEnabled();
        } else {
          this._analyticsDisabled();
        }
      },

      _setupRequestRoute: function(record) {
        var params = record && record.base;
        this.pageTitle = 'Request';
        if (!params || !params.type) {
          return;
        }
        var id;
        switch (params.type) {
          case 'history': id = params.id; break;
          case 'saved': id = params.id; break;
          case 'restore':
          case 'latest':
          case 'current':
            this.selectedRequest = undefined;
            return;
          case 'drive':
            // console.log(this.driveFileRoute);
            // debugger;
            this.selectedRequest = undefined;
            // return this.openDriveItem(params.driveId);
            return;
          default:
            this.selectedRequest = undefined;
            console.error('ID not handled!', params);
            throw new Error('ID not handled!');
        }
        this.selectedRequest = decodeURIComponent(id);
      },

      _driveFileRouteChanged: function(record) {
        var params = record && record.base;
        if (!params || !params.action || !params.id) {
          return;
        }
        // open and create actions are basically the same...
        this.openDriveItem(params.id);
      },

      openDriveItem: function(id) {
        Polymer.RenderStatus.afterNextRender(this, function() {
          if (!this.accessToken) {
            this.addEventListener('oauth-2-token-ready', function clb() {
              this.removeEventListener('oauth-2-token-ready', clb);
              this.openDriveItem(id);
            });
            return this._requestAuthToken(true);
          }
          this.fire('navigate', {
            base: 'drive'
          });
          var picker = Polymer.dom(this.root).querySelector('google-drive-browser');
          picker._isOpened = true;
          picker._downloadFile(id);
        });
      },
      /**
       * Handles opening a file from Google Drive.
       * Normalizes content to the import object and opens import panel
       * if the data is import data or a request if import data contains single
       * request.
       */
      _openDriveRequest: function(e) {
        var opts = {
          diveId: e.detail.diveId
        };
        this._processIcomingData(e.detail.content, opts);
      },

      _isSingleRequest: function(data) {
        if (!data.requests || !data.requests.length) {
          return false;
        }
        if (data.requests.length !== 1) {
          return false;
        }
        if (data.projects && data.projects.length === 0) {
          delete data.projects;
        }
        if (data.history && data.history.length === 0) {
          delete data.history;
        }
        if (Object.keys(data).length === 4) {
          return true;
        }
        return false;
      },

      _processIcomingDataHandler: function(e) {
        this._processIcomingData(e.detail.data);
      },

      _processIcomingData: function(data, opts) {
        if (!data) {
          return;
        }
        opts = opts || {};
        var event = this.fire('import-normalize', {
          content: data
        }, {
          cancelable: true
        });
        event.detail.result.then((data) => {
          if (this._isSingleRequest(data)) {
            let obj = data.requests[0];
            if (opts.diveId) {
              obj.type = 'google-drive';
              obj.driveId = opts.diveId;
            }
            Polymer.dom(this.root).querySelector('arc-request-panel').request = obj;
            this.fire('navigate', {
              base: 'request',
              type: 'current',
              id: '0'
            });
          } else {
            let panel = Polymer.dom(this.root).querySelector('data-import-export-panel');
            panel.importObject = data;
            panel.importPage = 3;
            this.openImportExport();
          }
        })
        .catch(cause => this.notifyError(cause.message));
      },

      notifyError: function(message) {
        this.$.errorToast.text = message;
        this.$.errorToast.opened = true;
      },

      // Starts listening for main script events.
      _observeMainEvents: function() {
        if (!this.__ueh) {
          this.__ueh = this._updateEventHandler.bind(this);
          this.__rah = this._requestActionHandler.bind(this);
          this.__ch = this._commandHandler.bind(this);
        }
        ipc.on('checking-for-update', this.__ueh);
        ipc.on('update-available', this.__ueh);
        ipc.on('update-not-available', this.__ueh);
        ipc.on('autoupdate-error', this.__ueh);
        ipc.on('download-progress', this.__ueh);
        ipc.on('update-downloaded', this.__ueh);
        ipc.on('request-action', this.__rah);
        ipc.on('command', this.__ch);
      },

      _unobserveMainEvents: function() {
        if (!this.__ueh) {
          return;
        }
        ipc.removeListener('checking-for-update', this.__ueh);
        ipc.removeListener('update-available', this.__ueh);
        ipc.removeListener('update-not-available', this.__ueh);
        ipc.removeListener('autoupdate-error', this.__ueh);
        ipc.removeListener('download-progress', this.__ueh);
        ipc.removeListener('update-downloaded', this.__ueh);
        ipc.removeListener('request-action', this.__rah);
        ipc.removeListener('command', this.__ch);
      },
      /**
       * Handler for the `navigate` custom event. Updates a route depending on
       * passed data.
       *
       */
      _navigateHandler: function(e) {
        var params = e.detail;
        var url;
        var screenName = '[unknown]';
        switch (params.base) {
          case 'default':
            url = '/request/latest/0';
            screenName = 'Request - latest';
          break;
          case 'history':
            url = '/history';
            screenName = 'History';
          break;
          case 'settings':
            url = '/settings';
            screenName = 'Settings';
          break;
          case 'about':
            url = '/about';
            screenName = 'About';
          break;
          case 'socket':
            url = '/socket';
            screenName = 'Socket';
          break;
          case 'saved':
            url = '/saved';
            screenName = 'Saved';
          break;
          case 'dataimport':
            url = '/dataimport';
            screenName = 'Data import / export';
          break;
          case 'project':
            if (params.id) {
              url = '/project/' + params.id;
              screenName = 'Project details';
            }
          break;
          case 'request':
            screenName = 'Request - ';
            let type = params.type || 'latest';
            let id = params.id || '0';
            screenName += type;
            url = '/request/' + type + '/' + encodeURIComponent(id);
          break;
          case 'drive':
            url = '/drive';
            screenName = 'Drive selector';
          break;
        }
        if (url) {
          this.set('route.path', url);
          this.fire('send-analytics', {
            type: 'screenview',
            name: screenName
          });
        } else {
          this.fire('send-analytics', {
            type: 'exception',
            description: 'Route not handled' + JSON.stringify(params),
            fatal: false
          });
          throw new Error('The route is not handled correctly', params);
        }
      },

      toggleDrawer: function() {
        if (this.narrowLayout) {
          return;
        }
        this.forceNarrowLayout = !this.forceNarrowLayout;
        this.async(function() {
          this.$.paperDrawerPanel.closeDrawer();
        }, 1);
      },

      _computePinDrawerClass: function(forceNarrowLayout, narrowLayout) {
        var clazz = 'drawer-pin';
        if (forceNarrowLayout && narrowLayout) {
          clazz += ' visible';
        }
        return clazz;
      },

      openAbout: function() {
        this.fire('navigate', {
          base: 'about'
        });
      },

      openDrivePicker: function() {
        this.fire('navigate', {
          base: 'drive'
        });
      },

      // Pin drawer back to the app.
      _pinDrawer: function() {
        this.forceNarrowLayout = false;
      },

      /**
       * Opens an issue tracker - new issue report.
       */
      openIssueReport: function() {
        var appVersion = this.appVersion;
        var message = 'Your description here\n\n';
        message += '## Expected outcome\nWhat should happen?\n\n';
        message += '## Actual outcome\nWhat happened?\n\n';
        message += `## Versions\nApp: ${appVersion}\n`;
        message += `Platform: ${navigator.appVersion}\n\n`;
        message += '## Steps to reproduce\n1. \n2. \n3. ';
        message = encodeURIComponent(message);
        window.open('https://github.com/jarrodek/ChromeRestClient/issues/new?body=' + message);
      },
      /**
       * Opens the import / export panel
       */
      openImportExport: function() {
        this.fire('navigate', {
          base: 'dataimport'
        });
      },
      /**
       * Opens the settings panel.
       */
      openSettings: function() {
        this.fire('navigate', {
          base: 'settings'
        });
      },

      openLicense: function() {
        var dialog = Polymer.dom(this.root).querySelector('arc-license-dialog');
        dialog.opened = true;
      },

      _drawerTrack: function(e) {
        switch (e.detail.state) {
          case 'start':
            this.__drawerTrackStart();
            break;
          case 'track':
            this.__drawerTrack(e.detail);
            break;
          case 'end':
            this.__drawerTrackEnd(e.detail);
            break;
        }
      },

      __drawerTrackStart: function() {
        var main = this.$.paperDrawerPanel.$.main;
        this.$.paperDrawerPanel.$.drawer.classList.remove('transition-drawer');
        this._drawerInitTransition = getComputedStyle(main).getPropertyValue('transition');
        main.style.transition = 'left ease-in-out 0.01s';
        this._drawerInitTrackWidth = Number(this.drawerWidth.replace('px', ''));
      },

      __drawerTrack: function(detail) {
        var newWidth = this._drawerInitTrackWidth + detail.dx;
        if (newWidth <= 10) {
          newWidth = 10;
        }
        this.drawerWidth = newWidth + 'px';
        this.$.paperDrawerPanel.$.main.style.transition = 'left ease-in-out 0.01s';
      },

      __drawerTrackEnd: function(detail) {
        this.$.paperDrawerPanel.$.drawer.classList.add('transition-drawer');
        this.$.paperDrawerPanel.$.main.style.transition = this._drawerInitTransition;
        var newWidth = this._drawerInitTrackWidth + detail.dx;
        if (newWidth <= 10) {
          newWidth = 10;
        }
        this.drawerWidth = newWidth + 'px';
        this._drawerInitTrackWidth = undefined;
        this._drawerInitTransition = undefined;
      },

      _handleLinks: function(e) {
        var target = e.path[0];
        if (!target) {
          return;
        }
        if (target.nodeName !== 'A') {
          return;
        }
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        const shell = require('electron').remote.shell;
        shell.openExternal(target.href);
      },

      _openExternalHandler: function(e) {
        e.preventDefault();
        const shell = require('electron').remote.shell;
        shell.openExternal(e.detail.url);
      },

      onNewWindow: function() {
        ipc.send('new-window');
      },

      openLogs: function() {
        ipc.send('toggle-devtools');
      },

      openImport: function() {
        this.fire('navigate', {
          base: 'dataimport'
        });
        var panel = this.$$('data-import-export-panel');
        panel.hideExport = true;
        panel.hideImport = false;
      },

      openExport: function() {
        this.fire('navigate', {
          base: 'dataimport'
        });
        var panel = this.$$('data-import-export-panel');
        panel.hideExport = false;
        panel.hideImport = true;
      },

      _copyContentHandler: function(e) {
        const {
          clipboard
        } = require('electron');
        clipboard.writeText(e.detail.value);
        e.preventDefault();
      },
      /**
       * Handler for update app events sent from main process.
       * Sets the `updateState` property that is passed to the about page.
       */
      _updateEventHandler: function(...args) {
        this.updateState = args[1];
      },
      /**
       * Handles action performed in main thread (menu action) related to
       * a request.
       *
       * @param {String} action Action name to perform.
       */
      _requestActionHandler: function(event, action) {
        if (this.routeData.base !== 'request') {
          return;
        }
        switch (action) {
          case 'save':
            this.$$('arc-request-panel').onSave({});
            break;
          case 'save-as':
            this.$$('arc-request-panel').onSave({
              source: 'shortcut',
              shift: true
            });
            break;
        }
      },
      /**
       * Handles action performed in main thread (menu action) related to
       * an application.
       *
       * @param {String} action Action name to perform.
       */
      _commandHandler: function(event, action) {
        switch (action) {
          case 'show-settings': this.openSettings(); break;
          case 'about': this.openAbout(); break;
          case 'open-license': this.openLicense(); break;
          case 'import-data': this.openImport(); break;
          case 'export-data': this.openExport(); break;
        }
      },

      _googleOauthTokenRequested: function(e) {
        var scope = e.detail.scope.split(' ');
        this._requestAuthToken(true, scope);
      },

      _requestAuthToken: function(interactive, scope) {
        if (this.__requestingToken) {
          return;
        }
        this.__requestingToken = true;
        ipc.send('oauth-2-get-token', {
          interactive: interactive,
          scopes: scope
        });
        var context = this;
        var rejected;
        function resolved(sender, token) {
          context.__requestingToken = false;
          ipc.removeListener('oauth-2-token-ready', resolved);
          ipc.removeListener('oauth-2-token-error', rejected);
          context.fire('google-signin-success', {
            scope: scope,
            token: token
          });
          context.accessToken = token;
        }
        rejected = function() {
          context.__requestingToken = false;
          ipc.removeListener('oauth-2-token-ready', resolved);
          ipc.removeListener('oauth-2-token-error', rejected);
          context.fire('google-signout', {
            scope: scope
          });
        };
        ipc.on('oauth-2-token-ready', resolved);
        ipc.on('oauth-2-token-error', rejected);
      },

      _appVersionRequestHandler: function(e) {
        e.detail.version = this.appVersion;
      }
    });
  </script>
</dom-module>
